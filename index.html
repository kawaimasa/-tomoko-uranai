<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”® æ™ºå­ã®å ã„é¤¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #2d1b69 50%, #1a0033 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: gold;
            font-size: 2.5em;
            margin: 30px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .fortune-teller-img {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
            border: 4px solid gold;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: rgba(138, 43, 226, 0.2);
            border: 3px solid gold;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 40px rgba(255, 215, 0, 0.5);
        }
        
        .fortune-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .fortune-card {
            background: rgba(138, 43, 226, 0.3);
            border: 3px solid gold;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .fortune-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
            border-color: #ffd700;
        }
        
        .fortune-card h3 {
            color: gold;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        
        .fortune-card p {
            color: #e0e0e0;
            font-size: 1.05em;
            line-height: 1.6;
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        .form-group.hidden {
            display: none;
        }
        
        label {
            display: block;
            color: gold;
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        label .optional {
            color: #aaa;
            font-size: 0.85em;
            font-weight: normal;
        }
        
        label .required {
            color: #ff6666;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid gold;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #1a0033;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button {
            width: 100%;
            padding: 18px;
            font-size: 1.3em;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a0033;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }
        
        button:disabled {
            background: gray;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-card {
            background: rgba(138, 43, 226, 0.3);
            border: 3px solid gold;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 2;
            font-size: 1.05em;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        .conversation-history {
            margin-bottom: 20px;
        }
        
        .message {
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
        }
        
        .user-message {
            background: rgba(100, 149, 237, 0.3);
            border-left: 5px solid cornflowerblue;
        }
        
        .ai-message {
            background: rgba(138, 43, 226, 0.3);
            border-left: 5px solid gold;
        }
        
        .question-counter {
            text-align: center;
            color: gold;
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: gold;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top-color: gold;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .back-button {
            background: rgba(100, 100, 100, 0.5);
            padding: 12px 30px;
            font-size: 1em;
            margin-bottom: 20px;
            width: auto;
        }
        
        .info-text {
            color: #aaa;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            .fortune-menu { grid-template-columns: 1fr; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”® æ™ºå­ã®å ã„é¤¨</h1>
        
        <img src="https://www.genspark.ai/api/files/s/PnQT1NL1?token=Z0FBQUFBQnBlM0pmd0VVVjBkRjVwbmVZZGNmbGM4TlJEUllRSkRxd2lqd2lnMWIwWkVWbUJYZVpJQkxhSl8yWFA4TUVJY2ppNmhnbFFuYlFpa3c0Z3lZbEtLZkZzWl8wUFp1d21HSzM3MmZYYU1vYTlzdFhFTnlvb2JQV210QVotWGY3ajBka2cxOFBBbGpCMHhOVlpYa2tjQlNSOWJnZWxwNkhVNTZjRzZKTTdyOGFDSF96X1dTdjlUcEhrMkxtb0RKaDQ4N2NlS2ViYnpzUGstM1Zoa0ROZU1YZUF3Y0V6U0ZQVkJSMF9UdWpBM3Y0NWRsYzNYZFdlVjB4dlR0WUU0ZUpIazRaM2RMSWFWTzEtaEZoYWVLRGtua2JkZ3h4ZEE9PQ" 
             alt="æ™ºå­" 
             class="fortune-teller-img"
             onerror="this.style.display='none'">
        
        <!-- å ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="menuScreen" class="screen active">
            <div class="card">
                <h2 style="color: gold; text-align: center; margin-bottom: 20px;">
                    ã‚ˆã†ã“ãã€‚ç§ã¯æ™ºå­ã§ã™ã€‚<br>
                    ã©ã®ã‚ˆã†ãªå ã„ã‚’ã”å¸Œæœ›ã§ã™ã‹ï¼Ÿ
                </h2>
            </div>
            
            <div class="fortune-menu">
                <div class="fortune-card" onclick="selectFortune('å››æŸ±æ¨å‘½')">
                    <h3>ğŸ‹ å››æŸ±æ¨å‘½</h3>
                    <p>ç”Ÿå¹´æœˆæ—¥ã¨æ™‚åˆ»ã‹ã‚‰ã€ã‚ãªãŸã®å‘½å¼ã‚’èª­ã¿è§£ãã¾ã™ã€‚æ€§æ ¼ã€æ‰èƒ½ã€é‹å‘½ã®æµã‚Œã‚’è©³ã—ãé‘‘å®šã—ã¾ã™ã€‚</p>
                </div>
                
                <div class="fortune-card" onclick="selectFortune('ã‚¿ãƒ­ãƒƒãƒˆå ã„')">
                    <h3>ğŸƒ ã‚¿ãƒ­ãƒƒãƒˆå ã„</h3>
                    <p>ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ç¥ç§˜çš„ãªåŠ›ã§ã€ã‚ãªãŸã®éå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥ã‚’å ã„ã¾ã™ã€‚</p>
                </div>
                
                <div class="fortune-card" onclick="selectFortune('æ°´æ™¶ç‰å ã„')">
                    <h3>ğŸ”® æ°´æ™¶ç‰å ã„</h3>
                    <p>æ°´æ™¶ç‰ã«æ˜ ã—å‡ºã•ã‚Œã‚‹å•“ç¤ºã‹ã‚‰ã€æ·±ã„æ´å¯Ÿã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚</p>
                </div>
                
                <div class="fortune-card" onclick="selectFortune('å§“ååˆ¤æ–­')">
                    <h3>ğŸ“ å§“ååˆ¤æ–­</h3>
                    <p>ãŠåå‰ã‹ã‚‰ã€ã‚ãªãŸã®æ€§è³ªã€é‹å‹¢ã€äººç”Ÿã®æ–¹å‘æ€§ã‚’èª­ã¿è§£ãã¾ã™ã€‚</p>
                </div>
                
                <div class="fortune-card" onclick="selectFortune('ç·åˆé‘‘å®š')">
                    <h3>âœ¨ ç·åˆé‘‘å®š</h3>
                    <p>å››æŸ±æ¨å‘½ã€å§“ååˆ¤æ–­ã€éœŠæ„Ÿã‚’çµ„ã¿åˆã‚ã›ãŸã€æœ€ã‚‚è©³ã—ã„é‘‘å®šã§ã™ã€‚</p>
                </div>
                
                <div class="fortune-card" onclick="selectFortune('æ‹æ„›ãƒ»ç›¸æ€§å ã„')">
                    <h3>ğŸ’• æ‹æ„›ãƒ»ç›¸æ€§å ã„</h3>
                    <p>æ°—ã«ãªã‚‹ç›¸æ‰‹ã¨ã®ç›¸æ€§ã€æ‹æ„›ã®è¡Œæ–¹ã‚’å ã„ã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- åŸºæœ¬æƒ…å ±å…¥åŠ›ç”»é¢ -->
        <div id="inputScreen" class="screen">
            <button class="back-button" onclick="goToMenu()">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            
            <div class="card">
                <h2 id="fortuneTitle" style="color: gold; text-align: center; margin-bottom: 30px;"></h2>
                
                <!-- å››æŸ±æ¨å‘½ç”¨ -->
                <div id="field-birthDate" class="form-group">
                    <label>ğŸ“… ç”Ÿå¹´æœˆæ—¥ <span class="required">*å¿…é ˆ</span></label>
                    <input type="date" id="birthDate" value="1990-01-01">
                </div>
                
                <div id="field-birthTime" class="form-group">
                    <label>â° ç”Ÿã¾ã‚ŒãŸæ™‚åˆ» <span class="required">*å¿…é ˆ</span></label>
                    <input type="time" id="birthTime" value="12:00">
                    <p class="info-text">â€»ã‚ã‹ã‚‰ãªã„å ´åˆã¯æ­£åˆï¼ˆ12:00ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
                
                <!-- åå‰ -->
                <div id="field-fullName" class="form-group">
                    <label>ğŸ‘¤ ãŠåå‰ <span id="nameRequired" class="required">*å¿…é ˆ</span><span id="nameOptional" class="optional hidden">ï¼ˆä»»æ„ï¼‰</span></label>
                    <input type="text" id="fullName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                </div>
                
                <!-- æ€§åˆ¥ -->
                <div id="field-gender" class="form-group">
                    <label>âš§ æ€§åˆ¥ <span class="optional">ï¼ˆä»»æ„ï¼‰</span></label>
                    <select id="gender">
                        <option value="">æŒ‡å®šã—ãªã„</option>
                        <option value="ç”·æ€§">ç”·æ€§</option>
                        <option value="å¥³æ€§">å¥³æ€§</option>
                    </select>
                </div>
                
                <!-- ç›¸æ‰‹ã®æƒ…å ±ï¼ˆæ‹æ„›å ã„ç”¨ï¼‰ -->
                <div id="field-partnerName" class="form-group hidden">
                    <label>ğŸ’• ç›¸æ‰‹ã®ãŠåå‰ <span class="optional">ï¼ˆä»»æ„ï¼‰</span></label>
                    <input type="text" id="partnerName" placeholder="ä¾‹: ä½è—¤èŠ±å­">
                </div>
                
                <div id="field-partnerBirthDate" class="form-group hidden">
                    <label>ğŸ“… ç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥ <span class="optional">ï¼ˆä»»æ„ãƒ»ã‚ã‹ã‚Œã°ï¼‰</span></label>
                    <input type="date" id="partnerBirthDate">
                    <p class="info-text">â€»ã‚ã‹ã‚‹å ´åˆã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚ˆã‚Šè©³ã—ã„ç›¸æ€§è¨ºæ–­ãŒã§ãã¾ã™ã€‚</p>
                </div>
                
                <!-- è³ªå•å†…å®¹ -->
                <div id="field-question" class="form-group">
                    <label>â“ <span id="questionLabel">å ã„ãŸã„å†…å®¹ãƒ»è³ªå•</span> <span class="required">*å¿…é ˆ</span></label>
                    <textarea id="question" placeholder="ä¾‹: ä»Šæ—¥ã®å•†è«‡ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„"></textarea>
                </div>
                
                <button onclick="startFortune()">âœ¨ å ã„ã‚’å§‹ã‚ã‚‹ âœ¨</button>
            </div>
        </div>
        
        <!-- å ã„çµæœãƒ»å¯¾è©±ç”»é¢ -->
        <div id="resultScreen" class="screen">
            <button class="back-button" onclick="goToMenu()">â† æœ€åˆã‹ã‚‰å ã†</button>
            
            <div class="question-counter" id="questionCounter">
                æ®‹ã‚Šè³ªå•å›æ•°: 2å›
            </div>
            
            <div class="conversation-history" id="conversationHistory"></div>
            
            <div id="followUpSection" class="card">
                <h3 style="color: gold; margin-bottom: 20px;">ğŸ“ è¿½åŠ ã®ã”è³ªå•</h3>
                <div class="form-group">
                    <textarea id="followUpQuestion" placeholder="ã•ã‚‰ã«è©³ã—ãçŸ¥ã‚ŠãŸã„ã“ã¨ã‚’ã”è³ªå•ãã ã•ã„..."></textarea>
                </div>
                <button id="followUpButton" onclick="askFollowUp()">ğŸ’¬ è³ªå•ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <script>
        // APIã‚­ãƒ¼ã¯Cloudflare Workerã§å®‰å…¨ã«ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™
        
        // çŠ¶æ…‹ç®¡ç†
        let currentFortune = '';
        let conversationHistory = [];
        let userInfo = {};
        let questionCount = 0;
        const MAX_QUESTIONS = 2;
        
        // å ã„ã”ã¨ã®å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
        const fortuneFields = {
            'å››æŸ±æ¨å‘½': {
                required: ['birthDate', 'birthTime', 'fullName', 'question'],
                optional: ['gender'],
                hidden: ['partnerName', 'partnerBirthDate'],
                questionLabel: 'å ã„ãŸã„å†…å®¹ãƒ»è³ªå•'
            },
            'ã‚¿ãƒ­ãƒƒãƒˆå ã„': {
                required: ['question'],
                optional: ['fullName'],
                hidden: ['birthDate', 'birthTime', 'gender', 'partnerName', 'partnerBirthDate'],
                questionLabel: 'å ã„ãŸã„å†…å®¹ï¼ˆéå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥ã«ã¤ã„ã¦ï¼‰'
            },
            'æ°´æ™¶ç‰å ã„': {
                required: ['question'],
                optional: ['fullName'],
                hidden: ['birthDate', 'birthTime', 'gender', 'partnerName', 'partnerBirthDate'],
                questionLabel: 'çŸ¥ã‚ŠãŸã„ã“ã¨ãƒ»æ‚©ã¿'
            },
            'å§“ååˆ¤æ–­': {
                required: ['fullName', 'question'],
                optional: ['birthDate', 'gender'],
                hidden: ['birthTime', 'partnerName', 'partnerBirthDate'],
                questionLabel: 'å ã„ãŸã„å†…å®¹'
            },
            'ç·åˆé‘‘å®š': {
                required: ['birthDate', 'birthTime', 'fullName', 'question'],
                optional: ['gender'],
                hidden: ['partnerName', 'partnerBirthDate'],
                questionLabel: 'è©³ã—ãçŸ¥ã‚ŠãŸã„å†…å®¹'
            },
            'æ‹æ„›ãƒ»ç›¸æ€§å ã„': {
                required: ['fullName', 'question'],
                optional: ['birthDate', 'gender', 'partnerName', 'partnerBirthDate'],
                hidden: ['birthTime'],
                questionLabel: 'æ‹æ„›ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã“ã¨'
            }
        };
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function goToMenu() {
            showScreen('menuScreen');
            conversationHistory = [];
            questionCount = 0;
            document.getElementById('conversationHistory').innerHTML = '';
        }
        
        function selectFortune(fortuneType) {
            currentFortune = fortuneType;
            document.getElementById('fortuneTitle').textContent = fortuneType;
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
            const fields = fortuneFields[fortuneType];
            
            // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            const allFields = ['birthDate', 'birthTime', 'fullName', 'gender', 'partnerName', 'partnerBirthDate', 'question'];
            allFields.forEach(field => {
                const fieldDiv = document.getElementById(`field-${field}`);
                if (fieldDiv) {
                    fieldDiv.classList.remove('hidden');
                }
            });
            
            // éè¡¨ç¤ºã«ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            fields.hidden.forEach(field => {
                const fieldDiv = document.getElementById(`field-${field}`);
                if (fieldDiv) {
                    fieldDiv.classList.add('hidden');
                }
            });
            
            // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¿…é ˆ/ä»»æ„è¡¨ç¤º
            const nameRequired = document.getElementById('nameRequired');
            const nameOptional = document.getElementById('nameOptional');
            if (fields.required.includes('fullName')) {
                nameRequired.classList.remove('hidden');
                nameOptional.classList.add('hidden');
            } else {
                nameRequired.classList.add('hidden');
                nameOptional.classList.remove('hidden');
            }
            
            // è³ªå•ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´
            document.getElementById('questionLabel').textContent = fields.questionLabel;
            
            showScreen('inputScreen');
        }
        
        async function startFortune() {
            const fields = fortuneFields[currentFortune];
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const errors = [];
            fields.required.forEach(field => {
                const value = document.getElementById(field).value;
                if (!value || value.trim() === '') {
                    const labels = {
                        birthDate: 'ç”Ÿå¹´æœˆæ—¥',
                        birthTime: 'ç”Ÿã¾ã‚ŒãŸæ™‚åˆ»',
                        fullName: 'ãŠåå‰',
                        question: 'è³ªå•å†…å®¹'
                    };
                    errors.push(labels[field]);
                }
            });
            
            if (errors.length > 0) {
                alert(`ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\nãƒ»${errors.join('\nãƒ»')}`);
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
            userInfo = {
                birthDate: document.getElementById('birthDate').value,
                birthTime: document.getElementById('birthTime').value,
                fullName: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                partnerName: document.getElementById('partnerName').value,
                partnerBirthDate: document.getElementById('partnerBirthDate').value,
                initialQuestion: document.getElementById('question').value
            };
            
            showScreen('resultScreen');
            questionCount = 0;
            updateQuestionCounter();
            
            // åˆå›å ã„
            await performFortune(userInfo.initialQuestion, true);
        }
        
        async function askFollowUp() {
            const question = document.getElementById('followUpQuestion').value.trim();
            
            if (!question) {
                alert('è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (questionCount >= MAX_QUESTIONS) {
                alert('è¿½åŠ è³ªå•ã¯2å›ã¾ã§ã§ã™ã€‚æ–°ã—ã„å ã„ã‚’å§‹ã‚ã‚‹ã«ã¯ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã£ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            questionCount++;
            updateQuestionCounter();
            document.getElementById('followUpQuestion').value = '';
            
            await performFortune(question, false);
        }
        
        function updateQuestionCounter() {
            const remaining = MAX_QUESTIONS - questionCount;
            const counterDiv = document.getElementById('questionCounter');
            
            if (remaining > 0) {
                counterDiv.textContent = `æ®‹ã‚Šè³ªå•å›æ•°: ${remaining}å›`;
                counterDiv.style.color = 'gold';
            } else {
                counterDiv.textContent = 'è³ªå•å›æ•°ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ã¨æ–°ã—ã„å ã„ãŒã§ãã¾ã™ï¼‰';
                counterDiv.style.color = '#ff6666';
                document.getElementById('followUpButton').disabled = true;
                document.getElementById('followUpQuestion').disabled = true;
            }
        }
        
        async function performFortune(question, isInitial) {
            const historyDiv = document.getElementById('conversationHistory');
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’è¡¨ç¤º
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.innerHTML = `<strong>ã‚ãªãŸ:</strong><br>${question}`;
            historyDiv.appendChild(userMsg);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai-message loading';
            loadingDiv.innerHTML = '<div class="spinner"></div><br>æ™ºå­ãŒé‘‘å®šä¸­...';
            historyDiv.appendChild(loadingDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            loadingDiv.scrollIntoView({ behavior: 'smooth' });
            
            try {
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
                let prompt;
                
                if (isInitial) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±éƒ¨åˆ†ã‚’å‹•çš„ã«ä½œæˆ
                    let userInfoText = '';
                    const fields = fortuneFields[currentFortune];
                    
                    if (!fields.hidden.includes('birthDate') && userInfo.birthDate) {
                        userInfoText += `ç”Ÿå¹´æœˆæ—¥: ${userInfo.birthDate}\n`;
                    }
                    if (!fields.hidden.includes('birthTime') && userInfo.birthTime) {
                        userInfoText += `æ™‚åˆ»: ${userInfo.birthTime}\n`;
                    }
                    if (userInfo.fullName) {
                        userInfoText += `åå‰: ${userInfo.fullName}\n`;
                    }
                    if (userInfo.gender) {
                        userInfoText += `æ€§åˆ¥: ${userInfo.gender}\n`;
                    }
                    if (userInfo.partnerName) {
                        userInfoText += `\nã€ç›¸æ‰‹ã®æƒ…å ±ã€‘\nç›¸æ‰‹ã®åå‰: ${userInfo.partnerName}\n`;
                    }
                    if (userInfo.partnerBirthDate) {
                        userInfoText += `ç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥: ${userInfo.partnerBirthDate}\n`;
                    }
                    
                    prompt = `ã‚ãªãŸã¯ã€Œæ™ºå­ã€ã¨ã„ã†åå‰ã®çµŒé¨“è±Šå¯Œãªå ã„å¸«ã§ã™ã€‚

ã€ç›¸è«‡è€…ã®æƒ…å ±ã€‘
${userInfoText}

ã€é¸æŠã•ã‚ŒãŸå ã„ã€‘
${currentFortune}

ã€è³ªå•å†…å®¹ã€‘
${question}

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
1. æ™ºå­ã¨ã—ã¦ã€è¦ªã—ã¿ã‚„ã™ãã€ã—ã‹ã—æ·±ã„æ´å¯ŸåŠ›ã‚’æŒã¤å ã„å¸«ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„
2. ${currentFortune}ã®æ‰‹æ³•ã‚’ç”¨ã„ã¦ã€æœ¬æ ¼çš„ã«å ã£ã¦ãã ã•ã„
3. 1500æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªé‘‘å®šçµæœã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
4. å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚ã¦ãã ã•ã„
5. ç›¸è«‡è€…ã«å¯„ã‚Šæ·»ã„ã€åŠ±ã¾ã—ã¨å¸Œæœ›ã‚’ä¸ãˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚ã¦ãã ã•ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”® æ™ºå­ã®é‘‘å®šçµæœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã”æŒ¨æ‹¶ã€‘
ï¼ˆæ™ºå­ã¨ã—ã¦ã®æŒ¨æ‹¶ï¼‰

ã€${currentFortune}ã«ã‚ˆã‚‹é‘‘å®šã€‘
ï¼ˆè©³ç´°ãªå ã„çµæœï¼‰

ã€å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
ï¼ˆå®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰

ã€æ™ºå­ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
ï¼ˆåŠ±ã¾ã—ã¨ç·æ‹¬ï¼‰

æ™ºå­ã‚ˆã‚Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
                } else {
                    // è¿½åŠ è³ªå•ã®å ´åˆã€ä¼šè©±å±¥æ­´ã‚’å«ã‚ã‚‹
                    const history = conversationHistory.map(h => 
                        `ã€${h.role}ã€‘\n${h.content}`
                    ).join('\n\n');
                    
                    prompt = `ã‚ãªãŸã¯ã€Œæ™ºå­ã€ã¨ã„ã†å ã„å¸«ã§ã™ã€‚ä»¥ä¸‹ã¯ä»Šã¾ã§ã®ä¼šè©±å±¥æ­´ã§ã™ã€‚

ã€ç›¸è«‡è€…ã®åŸºæœ¬æƒ…å ±ã€‘
${userInfo.fullName ? `åå‰: ${userInfo.fullName}` : ''}
${userInfo.birthDate ? `ç”Ÿå¹´æœˆæ—¥: ${userInfo.birthDate}` : ''}
${userInfo.birthTime ? `æ™‚åˆ»: ${userInfo.birthTime}` : ''}
${userInfo.gender ? `æ€§åˆ¥: ${userInfo.gender}` : ''}
å ã„ã®ç¨®é¡: ${currentFortune}

ã€ã“ã‚Œã¾ã§ã®ä¼šè©±ã€‘
${history}

ã€æ–°ã—ã„è³ªå•ã€‘
${question}

ã€æŒ‡ç¤ºã€‘
ã“ã‚Œã¾ã§ã®é‘‘å®šå†…å®¹ã‚’è¸ã¾ãˆã¦ã€æ–°ã—ã„è³ªå•ã«å¯¾ã—ã¦æ™ºå­ã¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
800æ–‡å­—ä»¥ä¸Šã§ã€å…·ä½“çš„ã‹ã¤è©³ç´°ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
å¿…ãšã€Œæ™ºå­ã‚ˆã‚Šã€ã§ç· ã‚ããã£ã¦ãã ã•ã„ã€‚`;
                }
                
                // Cloudflare WorkerçµŒç”±ã§APIå‘¼ã³å‡ºã—
                const response = await fetch(
                    'https://ootasensenraanai.kawai-6f8.workers.dev',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.9,
                                maxOutputTokens: 8000,
                                topP: 0.95,
                                topK: 64
                            }
                        })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const result = data.candidates[0].content.parts[0].text;
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                historyDiv.removeChild(loadingDiv);
                
                // çµæœã‚’è¡¨ç¤º
                const aiMsg = document.createElement('div');
                aiMsg.className = 'message ai-message';
                aiMsg.innerHTML = `<strong>æ™ºå­:</strong><br>${result.replace(/\n/g, '<br>')}`;
                historyDiv.appendChild(aiMsg);
                
                // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                conversationHistory.push(
                    { role: 'ã‚ãªãŸ', content: question },
                    { role: 'æ™ºå­', content: result }
                );
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                aiMsg.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                historyDiv.removeChild(loadingDiv);
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message ai-message';
                errorMsg.style.background = 'rgba(255, 0, 0, 0.3)';
                errorMsg.innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong><br>${error.message}`;
                historyDiv.appendChild(errorMsg);
            }
        }
    </script>
</body>
</html>
